name: Check Upstream & Prepare PR

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ (UTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹)
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch Upstream & Detect Changes
        id: detect_changes
        run: |
          git remote add upstream https://github.com/hsdn/tera-guide.git || true
          git fetch upstream master
          
          # ä½¿ç”¨ git log è·å–ä¸Šæ¸¸æœ€è¿‘çš„æäº¤ä¸­ä¿®æ”¹è¿‡çš„æ–‡ä»¶åˆ—è¡¨
          # HEAD..upstream/master è¡¨ç¤ºï¼šåœ¨ upstream/master ä¸­ä½†ä¸åœ¨ HEAD ä¸­çš„æäº¤
          CHANGED_FILES=$(git log HEAD..upstream/master --name-only --pretty=format: -- guides/ | sort -u | grep '\.js$' | grep -v '\.backup$' || true)
          
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No guide files changed in upstream"
            echo "has_upstream_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # ä¿å­˜å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          echo "has_upstream_changes=true" >> $GITHUB_OUTPUT
          
          # åªè¦†ç›–è¿™äº›å˜æ›´çš„æ–‡ä»¶
          while IFS= read -r file; do
            if [[ -n "$file" ]]; then
              echo "Updating: $file"
              git checkout upstream/master -- "$file"
            fi
          done < /tmp/changed_files.txt

      - name: Run Migration Script on Changed Files
        if: steps.detect_changes.outputs.has_upstream_changes == 'true'
        run: |
          # è¯»å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨å¹¶æå–å‰¯æœ¬ID
          DUNGEON_IDS=$(cat /tmp/changed_files.txt | sed 's|guides/||' | sed 's|\.js$||' | tr '\n' ' ')
          echo "Processing dungeon IDs: $DUNGEON_IDS"
          
          # å¯¹æ¯ä¸ªå‰¯æœ¬IDè¿è¡Œè¿ç§»
          for id in $DUNGEON_IDS; do
            if [[ -n "$id" ]]; then
              echo "Migrating: $id"
              node .github/scripts/migrate-to-i18n.js migrate-one "$id"
            fi
          done

      - name: Run Manifest Generator
        run: node .github/scripts/manifest-generator.js .

      - name: Check for Changes
        id: check_changes
        if: steps.detect_changes.outputs.has_upstream_changes == 'true'
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync with upstream and migrate to i18n"
          title: "ğŸš¨ Upstream Update Detected"
          body: |
            @Minor-fun ä¸Šæ¸¸ `hsdn/tera-guide` æœ‰æ›´æ–°ï¼
            
            æœºå™¨çŒ«å·²ç»è‡ªåŠ¨å®Œæˆäº†ä»¥ä¸‹å·¥ä½œï¼š
            1. æ£€æµ‹å¹¶æ‹‰å–äº†ä¸Šæ¸¸å˜æ›´çš„å‰¯æœ¬æ–‡ä»¶ï¼ˆåªè¦†ç›–å˜æ›´çš„æ–‡ä»¶ï¼‰ã€‚
            2. å¯¹å˜æ›´çš„æ–‡ä»¶æ‰§è¡Œäº† `migrate-to-i18n.js` æ ¼å¼è½¬æ¢ã€‚
            3. æ›´æ–°äº† `manifest.json`ã€‚
            
            **æ›´æ–°çš„æ–‡ä»¶åˆ—è¡¨ï¼š**
            æŸ¥çœ‹æœ¬ PR çš„æ–‡ä»¶å˜æ›´åˆ—è¡¨å³å¯çœ‹åˆ°å…·ä½“æ›´æ–°äº†å“ªäº›å‰¯æœ¬ã€‚
            
            **è¯·å®¡æŸ¥å˜æ›´å¹¶æ‰‹åŠ¨åˆå¹¶ã€‚**
          branch: auto-sync-upstream
          delete-branch: true
          base: master
          reviewers: Minor-fun
          assignees: Minor-fun