name: Check Upstream & Prepare PR

on:
  schedule:
    - cron: '0 2 * * *' # 每天凌晨2点运行 (UTC时间，北京时间上午10点)
  workflow_dispatch: # 手动触发

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch Upstream & Detect Changes
        id: detect_changes
        run: |
          git remote add upstream https://github.com/hsdn/tera-guide.git || true
          git fetch upstream master
          
          # 检查上游是否有新提交（所有提交，不只是 guides/）
          UPSTREAM_COMMITS=$(git log HEAD..upstream/master --oneline | head -20)
          
          if [[ -z "$UPSTREAM_COMMITS" ]]; then
            echo "No new upstream commits"
            echo "has_upstream_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Upstream commits to merge:"
          echo "$UPSTREAM_COMMITS"
          
          # 获取 guides/ 变更的文件列表（用于后续 i18n 迁移）
          CHANGED_FILES=$(git log HEAD..upstream/master --name-only --pretty=format: -- guides/ | sort -u | grep '\.js$' | grep -v '\.backup$' || true)
          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          
          echo "Changed guide files:"
          echo "$CHANGED_FILES"
          echo "has_upstream_changes=true" >> $GITHUB_OUTPUT
          
          # 记录是否有 guides 文件变更
          if [[ -n "$CHANGED_FILES" ]]; then
            echo "has_guide_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_guide_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge Upstream (preserve all history)
        if: steps.detect_changes.outputs.has_upstream_changes == 'true'
        run: |
          # 合并上游所有提交，冲突时优先使用上游版本（guides/ 后面会重新 i18n 转换）
          git merge upstream/master -X theirs --no-edit -m "chore: merge upstream changes" || {
            echo "Merge had conflicts, resolving..."
            # 对于 guides/ 目录，使用上游版本
            git checkout --theirs -- guides/ 2>/dev/null || true
            git add .
            git commit -m "chore: merge upstream changes (resolved conflicts)"
          }

      - name: Run Migration Script on Changed Files
        if: steps.detect_changes.outputs.has_guide_changes == 'true'
        run: |
          # 读取变更的文件列表并提取副本ID
          DUNGEON_IDS=$(cat /tmp/changed_files.txt | sed 's|guides/||' | sed 's|\.js$||' | tr '\n' ' ')
          echo "Processing dungeon IDs: $DUNGEON_IDS"
          
          # 对每个副本ID运行迁移（重新转换为 i18n 格式）
          for id in $DUNGEON_IDS; do
            if [[ -n "$id" ]]; then
              echo "Migrating: $id"
              node .github/scripts/migrate-to-i18n.js migrate-one "$id"
            fi
          done

      - name: Commit i18n Migration
        if: steps.detect_changes.outputs.has_guide_changes == 'true'
        run: |
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "chore: apply i18n migration to upstream changes"
          fi

      - name: Run Manifest Generator
        run: node .github/scripts/manifest-generator.js .

      - name: Check for Changes
        id: check_changes
        if: steps.detect_changes.outputs.has_upstream_changes == 'true'
        run: |
          # 检查是否有未提交的更改（manifest 等）
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "chore: update manifest"
          fi
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync with upstream and migrate to i18n"
          title: "Upstream Update Detected"
          body: |
            @Minor-fun 上游 `hsdn/tera-guide` 有更新！
            
            机器猫已经自动完成了以下工作：
            1. 检测并拉取了上游变更的副本文件（只覆盖变更的文件）。
            2. 对变更的文件执行了 `migrate-to-i18n.js` 格式转换。
            3. 更新了 `manifest.json`。
            
            **更新的文件列表：**
            查看本 PR 的文件变更列表即可看到具体更新了哪些副本。
            
            **请审查变更并手动合并。**
          branch: auto-sync-upstream
          delete-branch: true
          base: master
          reviewers: Minor-fun
          assignees: Minor-fun